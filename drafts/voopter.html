<!DOCTYPE html>
<html>
    <head>
          <title>Exploration of voopter airfare&nbsp;data - datawerk</title>
        <meta charset="utf-8" />
        <link href="https://buhrmann.github.io/theme/css/bootstrap-custom.css" rel="stylesheet"/> 
    	<link href="https://buhrmann.github.io/theme/css/pygments.css" rel="stylesheet"/>     
        <link href="https://buhrmann.github.io/theme/css/style.css" rel="stylesheet" />
        <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta name="author" contents="Thomas Buhrmann"/>  
  

    <meta name="keywords" contents="datawerk, R,visualization,exploratory,sql,"/>  

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-56071357-1', 'auto');
  ga('send', 'pageview');

</script>    </head>

    <body>
    <div class="wrap">
        <div class="container-fluid">
            <div class="header">
                <div class="container">
                    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
                        <div class="navbar-header">
                            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
                                <span class="sr-only">Toggle navigation</span>
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                            </button>
                            <a class="navbar-brand" href="https://buhrmann.github.io">
                                <!-- <span class="fa fa-pie-chart navbar-logo"></span> datawerk -->
                                <span class="navbar-logo"><img src="https://buhrmann.github.io/theme/css/logo.png" style=""></img></span>
                            </a>
                        </div>
                        <div class="navbar-collapse collapse">
                            <ul class="nav navbar-nav">
                                <!--<li><a href="https://buhrmann.github.io/archives.html">Archives</a></li>-->
                                <li><a href="https://buhrmann.github.io/posts.html">Blog</a></li>
                                <li><a href="https://buhrmann.github.io/pages/cv.html">Interactive CV</a></li>
                                <li class="dropdown">                                    
                                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Data Reports<span class="caret"></span></a>
                                    <ul class="dropdown-menu" role="menu">
                                        <!--<li class="divider"></li>
                                        <li class="dropdown-header">Data Science Reports</li>-->
                                        <li >
                                        <a href="https://buhrmann.github.io/p2p-loans.html">Interest rates on <span class="caps">P2P</span>&nbsp;loans</a>
                                        </li>
                                        <li >
                                        <a href="https://buhrmann.github.io/activity-data.html">Categorisation of inertial activity&nbsp;data</a>
                                        </li>
                                        <li >
                                        <a href="https://buhrmann.github.io/titanic-survival.html">Titanic survival&nbsp;prediction</a>
                                        </li>
                                    </ul>
                                </li>
                                <li class="dropdown">                                    
                                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Data Apps<span class="caret"></span></a>
                                    <ul class="dropdown-menu" role="menu">
                                        <!--<li class="divider"></li>
                                        <li class="dropdown-header">Data Science Reports</li>-->
                                        <li >
                                        <a href="https://buhrmann.github.io/elegans.html">C. elegans connectome&nbsp;explorer</a>
                                        </li>
                                        <li >
                                        <a href="https://buhrmann.github.io/dash+.html">Dash+ visualization of running&nbsp;data</a>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </nav>
                </div>
            </div><!-- header -->
        </div><!-- container-fluid -->

        <div class="container main-content">     
            <div class="row row-centered">
                <div class="col-centered col-max col-min col-sm-12 col-md-10 col-lg-10 main-content">
<section id="content" class="article content">
  <header>
      <span class="entry-title-info">Jul 14 Â· <a href="https://buhrmann.github.io/category/data-posts.html">Data Posts</a></span>
    <h2 class="entry-title entry-title-tight">Exploration of voopter airfare&nbsp;data</h2>
 
  </header>
  
     
  <div class="entry-content">
    <p>I&#8217;m currently helping my friends at <a href="https://voopter.com.br">voopter</a> analyze the data generated by airfare searches on their website. Voopter is a metasearch engine for flights from and to Brazil. At the moment this is a visual exploration only of the basic airfare data they have already collected. We will soon, however, be working on more specific business-driven questions. I will here share some ways of exploring flight search data in general (without giving away any of their specific insights), using R tools such as RPostgreSQL and dplyr to interact with sql&nbsp;data. </p>
<h3>Data&nbsp;preparation</h3>
<p>The original data is a structured text file (csv) covering over two million flight searches, more or less half of which are domestic and the other half international. The first step was to load this into a sql db (postgresql in this case). The following schema contains the data used in the&nbsp;anaylsis.</p>
<div class="highlight"><pre><span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">searches</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">searches</span> <span class="p">(</span>
    <span class="p">...</span>
    <span class="n">origin</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span>
    <span class="n">origin_city_name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span>
    <span class="n">origin_is_domestic</span> <span class="nb">boolean</span><span class="p">,</span>
    <span class="n">destination</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span>
    <span class="n">destination_city_name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span>
    <span class="n">destination_is_domestic</span> <span class="nb">boolean</span><span class="p">,</span>
    <span class="n">search_url</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">512</span><span class="p">),</span>
    <span class="n">leave_date</span> <span class="nb">date</span><span class="p">,</span>
    <span class="n">return_date</span> <span class="nb">date</span><span class="p">,</span>
    <span class="n">is_round_trip</span> <span class="nb">boolean</span><span class="p">,</span>
    <span class="n">leave_airline</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
    <span class="n">return_airline</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
    <span class="n">lowest_adult_price</span> <span class="nb">real</span><span class="p">,</span>
    <span class="n">created_at</span> <span class="k">timestamp</span><span class="p">,</span>
    <span class="p">...</span>
<span class="p">);</span>

<span class="k">ALTER</span> <span class="k">DATABASE</span> <span class="n">voopter</span> <span class="k">SET</span> <span class="n">datestyle</span> <span class="k">TO</span> <span class="ss">&quot;ISO, YMD&quot;</span><span class="p">;</span>

<span class="k">COPY</span> <span class="n">searches</span>
    <span class="k">FROM</span> <span class="s1">&#39;/Users/thomasbuhrmann/Datasets/voopter/searches.csv&#39;</span> 
    <span class="k">WITH</span> <span class="p">(</span><span class="k">DELIMITER</span> <span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="k">NULL</span> <span class="s1">&#39;NULL&#39;</span><span class="p">,</span> <span class="n">HEADER</span> <span class="k">TRUE</span><span class="p">,</span> <span class="n">FORMAT</span> <span class="n">CSV</span><span class="p">);</span>

<span class="c1">-- Make sure IATA airport codes are uniformly upper case</span>
<span class="k">UPDATE</span> <span class="n">searches</span> <span class="k">SET</span> <span class="n">origin</span> <span class="o">=</span> <span class="k">UPPER</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span> <span class="k">WHERE</span> <span class="n">origin</span> <span class="o">!=</span> <span class="k">UPPER</span><span class="p">(</span><span class="n">origin</span><span class="p">);</span>
<span class="k">UPDATE</span> <span class="n">searches</span> <span class="k">SET</span> <span class="n">destination</span> <span class="o">=</span> <span class="k">UPPER</span><span class="p">(</span><span class="n">destination</span><span class="p">)</span> <span class="k">WHERE</span> <span class="n">destination</span> <span class="o">!=</span> <span class="k">UPPER</span><span class="p">(</span><span class="n">destination</span><span class="p">);</span>
</pre></div>


<p>Which is followed by the creation of indices, ommitted here. I quickly realized that the queries I needed ran a little slow on the full database. However, I also found that most types of analysis where best carried out separately for domestic and international flights. I therefore created two corresponding materialized views, which cut the data in half and tended to be sufficient for acceptable performance. For example (omitting again the creation of&nbsp;indices):</p>
<div class="highlight"><pre><span class="k">CREATE</span> <span class="n">MATERIALIZED</span> <span class="k">VIEW</span> <span class="n">domestic</span> <span class="k">AS</span>
<span class="k">SELECT</span> <span class="n">origin</span> <span class="k">as</span> <span class="n">origin_iata</span><span class="p">,</span> <span class="n">origin_city_name</span> <span class="k">as</span> <span class="n">origin</span><span class="p">,</span> 
    <span class="n">destination</span> <span class="k">as</span> <span class="n">destination_iata</span><span class="p">,</span> <span class="n">destination_city_name</span> <span class="k">as</span> <span class="n">destination</span><span class="p">,</span> 
    <span class="n">leave_date</span><span class="p">,</span> <span class="n">is_round_trip</span> <span class="k">as</span> <span class="n">roundtrip</span><span class="p">,</span> <span class="n">lowest_adult_price</span> <span class="k">as</span> <span class="n">price</span><span class="p">,</span> 
    <span class="n">created_at</span> <span class="k">as</span> <span class="n">search_date</span><span class="p">,</span> <span class="p">(</span><span class="n">leave_date</span>  <span class="o">-</span> <span class="n">created_at</span><span class="p">::</span><span class="nb">date</span><span class="p">)</span> <span class="k">as</span> <span class="n">advance</span>
<span class="k">FROM</span> <span class="n">searches</span>
<span class="k">WHERE</span> <span class="n">origin_is_domestic</span> <span class="k">AND</span> <span class="n">destination_is_domestic</span><span class="p">;</span>
</pre></div>


<p>Since the original data contained only city information this wouldn&#8217;t have allowed me to aggregate, for example, by city or country. I therefore made use of <a href="http://openflights.org/data.html">openflights.org</a> data to map origins and destinations by <span class="caps">IATA</span> code to their geographical location. This is the airports&nbsp;schema:</p>
<div class="highlight"><pre><span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">airports</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">airports</span> <span class="p">(</span>
    <span class="n">airport_id</span> <span class="nb">integer</span><span class="p">,</span>
    <span class="n">name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
    <span class="n">city</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span>
    <span class="n">country</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span>
    <span class="n">iata</span> <span class="nb">char</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
    <span class="n">icao</span> <span class="nb">char</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
    <span class="p">...</span>
<span class="p">);</span>

<span class="k">COPY</span> <span class="n">airports</span>
    <span class="k">FROM</span> <span class="s1">&#39;/Users/thomasbuhrmann/Datasets/voopter/airports.csv&#39;</span> 
    <span class="k">WITH</span> <span class="p">(</span><span class="k">DELIMITER</span> <span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="k">NULL</span> <span class="s1">&#39;\N&#39;</span><span class="p">,</span> <span class="n">FORMAT</span> <span class="n">CSV</span><span class="p">);</span>

<span class="k">DROP</span> <span class="k">INDEX</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">airports_iata_idx</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">airports_iata_idx</span> <span class="k">ON</span> <span class="n">airports</span><span class="p">(</span><span class="n">iata</span><span class="p">);</span>
<span class="p">...</span>
</pre></div>


<h3>Most popular&nbsp;journeys</h3>
<p><img src="/images/voopter/top50journeys.png" alt="Top 50 journeys"/></p>
  </div><!-- /.entry-content -->
   <footer class="post-info">
    Published on <span class="published">July 14, 2015</span><br>
        Written by <span class="author">Thomas Buhrmann</span><br>
        Posted in <span class="label label-default"><a href="https://buhrmann.github.io/category/data-posts.html">Data Posts</a></span>
 ~ Tagged 
        <span class="label label-default"><a href="https://buhrmann.github.io/tag/r.html">R</a></span>
        <span class="label label-default"><a href="https://buhrmann.github.io/tag/visualization.html">visualization</a></span>
        <span class="label label-default"><a href="https://buhrmann.github.io/tag/exploratory.html">exploratory</a></span>
        <span class="label label-default"><a href="https://buhrmann.github.io/tag/sql.html">sql</a></span>
  </footer><!-- /.post-info -->
  
</section>
    <div class="blogItem">
    <h2>Comments</h2>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'datawerk';
        var disqus_title = 'Exploration of voopter airfare&nbsp;data';
        var disqus_identifier = "drafts/voopter.html";
        (function() {
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            //dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] ||
             document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>
        Please enable JavaScript to view the
        <a href="http://disqus.com/?ref_noscript=datawerk">
            comments powered by Disqus.
        </a>
    </noscript>
    </div>
                </div>
            </div><!-- row-->
        </div><!-- container -->

        <!-- <div class="push"></div> -->
    </div> <!-- wrap -->

    <div class="container-fluid aw-footer">
		<div class="row-centered">
			<div class="col-sm-3 col-sm-offset-1">
				<h4>Author</h4>
				<ul class="list-unstyled my-list-style">
					<li><a href="http://www.ias-research.net/people/thomas-buhrmann/">Academic Home</a></li>
					<li><a href="http://github.com/synergenz">Github</a></li>
					<li><a href="http://www.linkedin.com/in/thomasbuhrmann">LinkedIn</a></li>
					<li><a href="https://secure.flickr.com/photos/syngnz/">Flickr</a></li>                            
				</ul>
			</div>
			<div class="col-sm-3">
				<h4>Categories</h4>
				<ul class="list-unstyled my-list-style">
					<li><a href="https://buhrmann.github.io/category/academia.html">Academia (4)</a></li>
					<li><a href="https://buhrmann.github.io/category/data-apps.html">Data Apps (2)</a></li>
					<li><a href="https://buhrmann.github.io/category/data-posts.html">Data Posts (7)</a></li>
					<li><a href="https://buhrmann.github.io/category/reports.html">Reports (3)</a></li>
				</ul>
			</div>
			<div class="col-sm-3">
				<h4>Tags</h4>
                <ul class="tagcloud">
                        <li class="tag-2"><a href="https://buhrmann.github.io/tag/d3.html">d3</a></li>
                        <li class="tag-3"><a href="https://buhrmann.github.io/tag/neo4j.html">neo4j</a></li>
                        <li class="tag-2"><a href="https://buhrmann.github.io/tag/visualization.html">visualization</a></li>
                        <li class="tag-3"><a href="https://buhrmann.github.io/tag/sklearn.html">sklearn</a></li>
                        <li class="tag-2"><a href="https://buhrmann.github.io/tag/r.html">R</a></li>
                        <li class="tag-4"><a href="https://buhrmann.github.io/tag/text.html">text</a></li>
                        <li class="tag-1"><a href="https://buhrmann.github.io/tag/python.html">python</a></li>
                        <li class="tag-2"><a href="https://buhrmann.github.io/tag/smcs.html">smcs</a></li>
                        <li class="tag-4"><a href="https://buhrmann.github.io/tag/svm.html">svm</a></li>
                        <li class="tag-4"><a href="https://buhrmann.github.io/tag/random-forest.html">random forest</a></li>
                        <li class="tag-4"><a href="https://buhrmann.github.io/tag/scraping.html">scraping</a></li>
                        <li class="tag-4"><a href="https://buhrmann.github.io/tag/sql.html">sql</a></li>
                        <li class="tag-4"><a href="https://buhrmann.github.io/tag/java.html">java</a></li>
                        <li class="tag-2"><a href="https://buhrmann.github.io/tag/graph.html">graph</a></li>
                        <li class="tag-4"><a href="https://buhrmann.github.io/tag/regression.html">regression</a></li>
                        <li class="tag-3"><a href="https://buhrmann.github.io/tag/tf-idf.html">tf-idf</a></li>
                        <li class="tag-2"><a href="https://buhrmann.github.io/tag/report.html">report</a></li>
                        <li class="tag-2"><a href="https://buhrmann.github.io/tag/kaggle.html">kaggle</a></li>
                        <li class="tag-2"><a href="https://buhrmann.github.io/tag/nosql.html">nosql</a></li>
                        <li class="tag-4"><a href="https://buhrmann.github.io/tag/lda.html">lda</a></li>
                        <li class="tag-4"><a href="https://buhrmann.github.io/tag/titanic.html">titanic</a></li>
                        <li class="tag-2"><a href="https://buhrmann.github.io/tag/classification.html">classification</a></li>
                        <li class="tag-4"><a href="https://buhrmann.github.io/tag/big-data.html">big data</a></li>
                        <li class="tag-4"><a href="https://buhrmann.github.io/tag/mongodb.html">mongodb</a></li>
                        <li class="tag-4"><a href="https://buhrmann.github.io/tag/hadoop.html">hadoop</a></li>
                </ul>
			</div>
		</div>
    </div>
<!-- JavaScript -->
<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script type="text/javascript">
jQuery(document).ready(function($) 
{
	$("div.collapseheader").click(function () {
		$header = $(this).children("span").first();
		$codearea = $(this).children(".input_area");
		$codearea.slideToggle(500, function () {
			$header.text(function () {
				return $codearea.is(":visible") ? "Collapse Code" : "Expand Code";
			});
		});
	});


    // $(window).resize(function(){
    //     var footerHeight = $('.aw-footer').outerHeight();
    //     var stickFooterPush = $('.push').height(footerHeight);  
    //     $('.wrap').css({'marginBottom':'-' + footerHeight + 'px'});
    // });     

    // $(window).resize();

    // $(window).bind("load resize", function() {    
    //     var footerHeight = 0,
    //         footerTop = 0,
    //         $footer = $(".aw-footer");

    //     positionFooter();

    //     function positionFooter() {

    //         footerHeight = $footer.height();
    //         footerTop = ($(window).scrollTop()+$(window).height()-footerHeight)+"px";
    //         console.log(footerHeight, footerTop);
    //         console.log($(document.body).height()+footerHeight, $(window).height());

    //         if ( ($(document.body).height()+footerHeight) < $(window).height()) {
    //             $footer.css({ position: "absolute" }).css({ top: footerTop });
    //             console.log("Positioning absolute");
    //         }
    //         else {
    //             $footer.css({ position: "static" });
    //             console.log("Positioning static");
    //         }
    //     }

    //     $(window).scroll(positionFooter).resize(positionFooter);
    // });
});
</script>
</body>
</html>